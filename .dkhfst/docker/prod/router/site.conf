# =========================================
# Frontend Web Server
# =========================================

# Redirect HTTP â†’ HTTPS
server {
    listen 80;
    server_name dkhfst-app.test *.dkhfst-app.test;
    return 301 https://$host$request_uri;
}

# HTTPS Proxy
server {
    listen 443 ssl;
    server_name dkhfst-app.test *.dkhfst-app.test;

    ssl_certificate     /certs/frontend-web.crt;
    ssl_certificate_key /certs/frontend-web.key;

    location / {
        proxy_pass https://frontend-web-server:443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =========================================
# Frontend Mobile Server
# =========================================

server {
    listen 80;
    server_name m.dkhfst-app.test *.m.dkhfst-app.test;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name m.dkhfst-app.test *.m.dkhfst-app.test;

    ssl_certificate     /certs/frontend-mobile.crt;
    ssl_certificate_key /certs/frontend-mobile.key;

    location / {
        proxy_pass https://frontend-mobile-server:443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =========================================
# Backend Server (API)
# =========================================

server {
    listen 80;
    server_name api.dkhfst-app.test;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name api.dkhfst-app.test;

    ssl_certificate     /certs/http-api.crt;
    ssl_certificate_key /certs/http-api.key;

    location / {
        proxy_pass https://backend-server:443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =========================================
# Adminer
# =========================================

server {
    listen 80;
    server_name adminer.dkhfst-app.test;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name adminer.dkhfst-app.test;

    ssl_certificate     /certs/adminer.crt;
    ssl_certificate_key /certs/adminer.key;

    location / {
        proxy_pass https://adminer-server:443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}



# =========================================
# Mailpit
# =========================================

server {
    listen 80;
    server_name mailpit.dkhfst-app.test;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name mailpit.dkhfst-app.test;

    ssl_certificate     /certs/mailpit.crt;
    ssl_certificate_key /certs/mailpit.key;

    location / {
        proxy_pass https://mailpit-server:443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =========================================
# Realtime WebSockets
# =========================================
server {
    listen 80;
    server_name realtime.dkhfst-app.test realtime.localhost;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name realtime.dkhfst-app.test realtime.localhost;

    ssl_certificate     /certs/ws-api.crt;
    ssl_certificate_key /certs/ws-api.key;

    location / {
        proxy_pass http://websockets-server:80;
        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}